<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BISC Side-Kick</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    /* GOOGLE CARD STYLE */
    body { background-color: #f5f5f5; color: #3c4043; font-family: 'Roboto', sans-serif; margin: 0; padding-bottom: 20px; }
    .container { max-width: 480px; margin: 10px auto; padding: 0 8px; }
    
    .card {
      background: white; border: 1px solid #dadce0; border-radius: 8px;
      overflow: hidden; margin-bottom: 10px;
    }
    
    .section { border-bottom: 1px solid #e0e0e0; padding: 16px; }
    .section:last-child { border-bottom: none; }
    
    .section-header { 
      font-size: 14px; font-weight: 500; color: #3c4043; 
      display: flex; align-items: center; margin-bottom: 12px; 
    }
    .section-header i { margin-right: 12px; color: #5f6368; font-size: 18px; }

    /* UNIVERSAL NAV BAR */
    .nav-bar { 
      display: flex; justify-content: space-around; align-items: center; 
      background: white; padding: 8px 0; border-bottom: 1px solid #e0e0e0;
    }
    .nav-btn { 
      background: none; border: none; cursor: pointer; padding: 8px; 
      color: #5f6368; display: flex; flex-direction: column; align-items: center;
    }
    .nav-btn i { font-size: 24px; }
    .nav-btn:active { color: #1a73e8; }

    /* FORM ELEMENTS */
    input[type=text], select {
      width: 100%; padding: 10px 0; border: none; border-bottom: 1px solid #dadce0;
      font-size: 16px; outline: none; background: transparent;
    }
    input:focus, select:focus { border-bottom: 2px solid #1a73e8; }
    
    .btn-row { display: flex; gap: 8px; margin-top: 16px; }
    .btn {
      flex: 1; padding: 8px; text-align: center; border-radius: 4px; cursor: pointer;
      font-weight: 500; font-size: 14px; border: 1px solid #dadce0; background: white; color: #1a73e8;
    }
    .btn:hover { background: #f8f9fa; }
    .btn.disabled { color: #bdc1c6; pointer-events: none; }

    /* LIST ITEMS */
    .list-item { 
      display: flex; align-items: center; padding: 12px 0; border-top: 1px solid #f1f3f4; cursor: pointer; 
    }
    .list-item:first-child { border-top: none; }
    .list-item img { width: 40px; height: 40px; border-radius: 4px; margin-right: 16px; object-fit: cover; background: #eee; }
    .list-item .text { display: flex; flex-direction: column; }
    .list-item .title { font-weight: 500; font-size: 14px; color: #202124; }
    .list-item .sub { font-size: 12px; color: #5f6368; }

    /* STUDENT DETAILS */
    .detail-photo { width: 100%; max-width: 250px; border-radius: 8px; margin: 16px auto; display: block; object-fit: cover; }
    .detail-row { margin-bottom: 16px; }
    .detail-label { font-size: 12px; color: #5f6368; display: block; margin-bottom: 4px; }
    .detail-val { font-size: 14px; color: #202124; }
    .link { color: #1a73e8; text-decoration: none; cursor: pointer; }

    /* PHOTO GRID */
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .grid-item { text-align: center; cursor: pointer; }
    .grid-item img { width: 100%; aspect-ratio: 3/4; object-fit: cover; border-radius: 4px; background: #eee; }
    .grid-item div { font-size: 11px; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* LOADER */
    .loader { text-align: center; padding: 40px; color: #1a73e8; }
  </style>
</head>
<body>

<div id="app"></div>

<script>
// --- CONFIGURATION ---
const API = "https://script.google.com/macros/s/AKfycbydEfDnhHA8n-IMcdpiU4vYqwPxDwU_8Nq3Fqbw3N7jVsgztGykYkJb7fxW2PL3J-hPHw/exec";

// --- STATE ---
let state = {
  hierarchy: {}, peClasses: [], 
  recents: JSON.parse(localStorage.getItem('recents')||'[]'),
  starred: JSON.parse(localStorage.getItem('starred')||'[]'),
  currentList: [], currentIndex: -1, currentStudent: null
};

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
  renderLoader();
  fetchAPI('getHomepageData', {}, init);
});

function init(data) {
  state.hierarchy = data.classHierarchy;
  state.peClasses = data.peClasses;
  renderHome();
}

// --- RENDERERS ---

function renderHome() {
  const years = Object.keys(state.hierarchy).map(y => `<option value="${y}">${y}</option>`).join('');
  const pes = state.peClasses.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
  
  const recentsHtml = createList(state.recents, 'No recent searches.');
  const starredHtml = createList(state.starred, 'No starred students.');

  document.getElementById('app').innerHTML = `
    <div class="card">
      ${createNavBar('home')}
      
      <div class="section">
        <div class="section-header"><i class="material-icons">search</i>Student Search</div>
        <input type="text" id="search" placeholder="Enter name, email, or ID..." onchange="handleSearch()">
      </div>

      <div class="section">
        <div class="section-header"><i class="material-icons">photo_camera</i>Class Photo Viewer</div>
        <select id="year" onchange="loadClasses(this.value)"><option value="" disabled selected>Year Group</option>${years}</select>
        <select id="class" disabled><option>Class</option></select>
        <select id="pe"><option value="" disabled selected>PE Class</option>${pes}</select>
        
        <div class="btn-row">
          <div class="btn" onclick="handleView('year')">Year</div>
          <div class="btn" onclick="handleView('class')">Class</div>
          <div class="btn" onclick="handleView('pe')">PE</div>
        </div>
      </div>

      <div class="section">
        <div class="section-header"><i class="material-icons">history</i>Recent Searches</div>
        ${recentsHtml}
      </div>

      <div class="section">
        <div class="section-header"><i class="material-icons">star</i>Starred Students</div>
        ${starredHtml}
      </div>

      <div class="section" style="display:flex; justify-content:center; gap:20px;">
         <span class="link" onclick="renderHelp()">Help</span>
         <span class="link" onclick="renderFeedback()">Feedback</span>
         <span class="link" onclick="renderAbout()">About</span>
      </div>
    </div>
  `;
}

function renderSearchResults(list) {
  state.currentList = list.map(s => s.row);
  document.getElementById('app').innerHTML = `
    <div class="card">
      ${createNavBar()}
      <div class="section">
        <div class="section-header"><i class="material-icons">list</i>Search Results (${list.length})</div>
        ${createList(list, 'No matches found.')}
      </div>
    </div>`;
}

function renderDetails(s) {
  // Update state
  state.currentStudent = s;
  state.currentIndex = state.currentList.indexOf(parseInt(s.row));
  addToRecents(s);

  // Star Icon logic
  const isStarred = state.starred.some(st => st.row == s.row);
  const starIcon = isStarred ? 'star' : 'star_border';

  document.getElementById('app').innerHTML = `
    <div class="card">
      ${createNavBar('details')}
      <div style="padding:16px; text-align:center;">
        <h2 style="margin:0; font-size:20px; font-weight:400;">${s.name}</h2>
      </div>
      <img src="${s.photoUrl}" class="detail-photo">
      
      <div class="section">
        <div class="section-header">üë§ Student Details</div>
        ${item('Admission Number', s.admissionNumber)}
        ${item('Date of Birth', s.dob)}
        ${item('Current Age', s.currentAge)}
        ${item('Sports Age', s.sportsAge)}
        <div class="detail-row">
           <span class="detail-label">Year / Form</span>
           <span class="detail-val link" onclick="loadClassView('${s.yearGroup}', '${s.form}')">${s.yearGroup} / ${s.form}</span>
        </div>
      </div>

      <div class="section">
        <div class="section-header">üìû Contact Information</div>
        ${emailItem('Student Email', s.email)}
        ${item("Father's Mobile", s.fatherMobile)}
        ${emailItem("Father's Email", s.fatherEmail)}
        ${item("Mother's Mobile", s.motherMobile)}
        ${emailItem("Mother's Email", s.motherEmail)}
        <div class="detail-row">
           <span class="detail-label">Parents Greeting</span>
           <span class="detail-val">Coming soon</span>
        </div>
      </div>

      <div class="section">
        <div class="section-header">‚öïÔ∏è Medical Information</div>
        ${item('Medical Comments', s.medicalComments)}
        ${item('Ailment', s.ailment)}
        ${item('Allergy', s.allergy)}
      </div>
    </div>`;
}

function renderViewer(data) {
  state.currentList = data.students.map(s => s.row);
  const grid = data.students.map(s => `
    <div class="grid-item" onclick="fetchStudent('${s.row}')">
      <img src="${s.photoUrl}" loading="lazy">
      <div>${s.name}</div>
    </div>
  `).join('');

  document.getElementById('app').innerHTML = `
    <div class="card">
      ${createNavBar()}
      <div class="section">
        <h3 style="font-size:16px; margin:0 0 10px 0;">${data.title} (${data.students.length})</h3>
        <div class="grid">${grid}</div>
      </div>
    </div>`;
}

function renderHelp() {
  document.getElementById('app').innerHTML = `
    <div class="card">
      ${createNavBar()}
      <div class="section">
        <div class="section-header">Help & Instructions</div>
        <p><b>Navigating:</b> Use the top bar to go Home, Search, or cycle (Back/Next) through students.</p>
        <p><b>Searching:</b> Enter Name, ID, Parent Email or Phone.</p>
        <p><b>Class Photo Viewer:</b> Select Year/Class/PE to view grid.</p>
        <p><b>Starred:</b> Click the Star icon in the nav bar to view favorites.</p>
        <div class="btn" onclick="renderHome()">Back Home</div>
      </div>
    </div>`;
}

function renderFeedback() {
  document.getElementById('app').innerHTML = `
    <div class="card">
      ${createNavBar()}
      <div class="section">
        <div class="section-header">Send Feedback</div>
        <p>We appreciate your feedback! Describe your issue below.</p>
        <textarea id="fb" style="width:100%; height:100px; border:1px solid #ddd;"></textarea>
        <div class="btn" style="margin-top:10px;" onclick="submitFeedback()">Submit</div>
      </div>
    </div>`;
}

// --- UI COMPONENTS ---

function createNavBar(context) {
  // Exact layout: Home | Search | Prev | Next | Star
  const isDetail = context === 'details';
  
  // Dynamic Star Icon based on current student state if in details
  let starAction = "viewStarred()";
  let starIcon = "star";
  
  if (isDetail && state.currentStudent) {
    const isStarred = state.starred.some(s => s.row == state.currentStudent.row);
    starIcon = isStarred ? "star" : "star_border";
    starAction = "toggleStar()";
  }

  return `
    <div class="nav-bar">
      <button class="nav-btn" onclick="renderHome()"><i class="material-icons">home</i></button>
      <button class="nav-btn" onclick="focusSearch()"><i class="material-icons">search</i></button>
      <button class="nav-btn ${!isDetail?'disabled':''}" onclick="nav(-1)"><i class="material-icons">arrow_back</i></button>
      <button class="nav-btn ${!isDetail?'disabled':''}" onclick="nav(1)"><i class="material-icons">arrow_forward</i></button>
      <button class="nav-btn" onclick="${starAction}"><i class="material-icons">${starIcon}</i></button>
    </div>
  `;
}

function createList(list, emptyMsg) {
  if (!list.length) return `<div style="padding:10px; color:#999; font-style:italic;">${emptyMsg}</div>`;
  return list.map(s => `
    <div class="list-item" onclick="fetchStudent('${s.row}')">
      <img src="${s.photoUrl}">
      <div class="text">
        <span class="title">${s.name}</span>
        <span class="sub">${s.email || ''}</span>
      </div>
    </div>
  `).join('');
}

function item(lbl, val) {
  if (!val || val === 'N/A') return '';
  return `<div class="detail-row"><span class="detail-label">${lbl}</span><span class="detail-val">${val}</span></div>`;
}

function emailItem(lbl, val) {
  if (!val || val === 'N/A') return '';
  return `<div class="detail-row"><span class="detail-label">${lbl}</span><a href="https://mail.google.com/mail/?view=cm&fs=1&to=${val}" target="_blank" class="link">${val}</a></div>`;
}

function renderLoader() {
  document.getElementById('app').innerHTML = '<div class="loader"><i class="material-icons" style="font-size:48px; animation: spin 1s infinite linear;">autorenew</i></div>';
}

// --- LOGIC ---

function fetchAPI(act, p, cb) {
  const url = new URL(API);
  url.searchParams.append('action', act);
  for(let k in p) if(p[k]) url.searchParams.append(k, p[k]);
  
  fetch(url).then(r=>r.json()).then(d => {
    if(d.error) alert("Error: " + d.error);
    else cb(d);
  }).catch(e => alert("Network Error: " + e));
}

function handleSearch() {
  const term = document.getElementById('search').value;
  if (!term) return;
  renderLoader();
  fetchAPI('search', {term}, renderSearchResults);
}

function fetchStudent(row) {
  renderLoader();
  fetchAPI('getStudentDetails', {row}, renderDetails);
}

function loadClasses(year) {
  const forms = state.hierarchy[year].classes;
  const sel = document.getElementById('class');
  sel.innerHTML = '<option disabled selected>Class</option>' + forms.map(f => `<option value="${f}">${f}</option>`).join('');
  sel.disabled = false;
}

function handleView(type) {
  const yg = document.getElementById('year') ? document.getElementById('year').value : null;
  const fm = document.getElementById('class') ? document.getElementById('class').value : null;
  const pe = document.getElementById('pe') ? document.getElementById('pe').value : null;
  
  let p = { yearGroup: yg, form: fm, peClass: pe };
  
  if (type === 'year' && !yg) return;
  if (type === 'class' && (!yg || !fm)) return;
  if (type === 'pe' && !pe) return;

  renderLoader();
  fetchAPI('getView', {viewType: type, ...p}, renderViewer);
}

function loadClassView(y, f) {
  renderLoader();
  fetchAPI('getView', {viewType:'class', yearGroup:y, form:f}, renderViewer);
}

function nav(dir) {
  const nextIdx = state.currentIndex + dir;
  if (nextIdx >= 0 && nextIdx < state.currentList.length) {
    fetchStudent(state.currentList[nextIdx]);
  }
}

function toggleStar() {
  const s = state.currentStudent;
  const idx = state.starred.findIndex(x => x.row == s.row);
  
  if (idx > -1) state.starred.splice(idx, 1);
  else state.starred.push({name: s.name, row: s.row, photoUrl: s.photoUrl, email: s.email});
  
  localStorage.setItem('starred', JSON.stringify(state.starred));
  renderDetails(s); // Re-render to update star icon
}

function viewStarred() {
  document.getElementById('app').innerHTML = `
    <div class="card">
      ${createNavBar()}
      <div class="section">
        <div class="section-header"><i class="material-icons">star</i>Starred Students</div>
        ${createList(state.starred, 'No favorites yet.')}
      </div>
    </div>`;
}

function addToRecents(s) {
  const idx = state.recents.findIndex(x => x.row == s.row);
  if (idx > -1) state.recents.splice(idx, 1);
  state.recents.unshift({name: s.name, row: s.row, photoUrl: s.photoUrl, email: s.email});
  if (state.recents.length > 5) state.recents.pop();
  localStorage.setItem('recents', JSON.stringify(state.recents));
}

function focusSearch() {
  renderHome();
  setTimeout(() => document.getElementById('search').focus(), 100);
}

function submitFeedback() {
  const t = document.getElementById('fb').value;
  if(t) fetchAPI('feedback', {text:t}, () => { alert("Feedback Sent!"); renderHome(); });
}

// Service Worker for Install
if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>

<style>
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</body>
</html>
