<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BISC Side-Kick</title>
  
  <!-- PWA Settings -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="icon.png">

  <!-- Materialize CSS & Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

  <style>
    body { background-color: #f5f5f5; color: #3c4043; font-family: 'Roboto', sans-serif; padding-bottom: 20px; }
    .container { max-width: 450px; margin-top: 10px; }
    .card-panel { padding: 0; border: 1px solid #dadce0; border-radius: 8px; background-color: #fff; }
    .section { border-bottom: 1px solid #e0e0e0; padding: 16px; }
    .section:last-child { border-bottom: none; }
    .section-header { font-size: 1rem; font-weight: 500; color: #3c4043; display: flex; align-items: center; margin-bottom: 16px; }
    .section-header i { margin-right: 16px; color: #5f6368; }
    .nav-bar { display: flex; justify-content: space-around; padding: 8px 0; background-color: #fff; }
    .nav-bar a { color: #5f6368; cursor: pointer; }
    .student-list-item { display: flex; align-items: center; padding: 12px 0; cursor: pointer; border-top: 1px solid #e8eaed; }
    .student-list-item img { width: 40px; height: 40px; border-radius: 4px; margin-right: 16px; object-fit: cover; }
    .student-list-item .info { display: flex; flex-direction: column; }
    .student-list-item .info .name { font-weight: 500; color: #202124; }
    .student-list-item .info .email { font-size: 0.875rem; color: #5f6368; }
    .student-photo { max-width: 280px; border-radius: 8px; margin: 16px auto; display: block; }
    .detail-item { margin-bottom: 16px; }
    .detail-item .label { font-size: 0.75rem; color: #5f6368; display: block; margin-bottom: 2px; }
    .detail-item .value { font-size: 1rem; color: #202124; }
    .btn-group { display: flex; justify-content: space-between; margin-top: 16px; }
    .btn-group .btn-small { width: 32%; background-color: #fff; color: #3c4043; border: 1px solid #dadce0; box-shadow: none; }
    .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 16px; }
    .photo-grid-item { text-align: center; cursor: pointer; }
    .photo-grid-item img { width: 100%; border-radius: 4px; object-fit: cover; aspect-ratio: 3/4; }
    .photo-grid-item .name { font-size: 0.8rem; margin-top: 4px; line-height: 1.2; }
    .email-link { color: #1a73e8; text-decoration: none; display: flex; align-items: center; }
    .email-link i { font-size: 16px; margin-left: 4px; color: #5f6368; }
  </style>
</head>

<body>
  <div id="app-container" class="container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script>
    // =========================================================
    // === 1. CONFIGURATION ===
    // =========================================================
    
    const API_URL = "https://script.google.com/macros/s/AKfycbyMlIoIMhJVNgXzS1VvVlRMtlVEWOA9UNU8CEciZ7JWJNRan_yCG_7mIWiYu4wxxAfHBQ/exec";

    // =========================================================
    // === 2. THE API BRIDGE ===
    // =========================================================
    const google = {
      script: {
        run: {
          success: null, failure: null,
          withSuccessHandler: function(cb) { this.success = cb; return this; },
          withFailureHandler: function(cb) { this.failure = cb; return this; },
          
          getHomepageData: function() { this._call('getHomepageData'); },
          searchSheetLive: function(term) { this._call('search', {term: term}); },
          getStudentDetailsForWebApp: function(row) { this._call('getStudentDetails', {row: row}); },
          getStudentsForView: function(type, params) { 
             this._call('getView', {viewType: type, yearGroup: params.yearGroup, form: params.form, peClass: params.peClass}); 
          },
          webSaveSportsAge: function(d) { /* Not supported in read-only API */ },
          webSendFeedback: function(t) { /* Not supported in read-only API */ },

          _call: function(action, params = {}) {
            const self = this;
            const url = new URL(API_URL);
            url.searchParams.append('action', action);
            for (const key in params) { if (params[key]) url.searchParams.append(key, params[key]); }

            fetch(url)
              .then(response => response.json())
              .then(data => {
                if (data.error && self.failure) self.failure(new Error(data.error));
                else if (self.success) self.success(data);
              })
              .catch(err => { if (self.failure) self.failure(err); });
          }
        }
      }
    };

    // =========================================================
    // === 3. APP LOGIC (UI) ===
    // =========================================================
    
    const app = document.getElementById('app-container');
    window.appState = { classHierarchy: {}, currentList: [], currentIndex: -1, isPeTeacher: true };

    document.addEventListener('DOMContentLoaded', () => {
      showLoader();
      google.script.run.withSuccessHandler(initApp).withFailureHandler(showError).getHomepageData();
    });

    function initApp(data) {
      if (data.error) return showError({ message: data.error });
      window.appState.classHierarchy = data.classHierarchy || {};
      window.appState.peClasses = data.peClasses || [];
      renderHomepage(data);
    }

    function renderHomepage(data) {
      const peSection = `<div class="input-field"><select id="pe-selector">${createOptions(data.peClasses, 'PE Class')}</select></div>`;
      
      const html = `
        <div class="card-panel">
          ${createNavBar()}
          <div class="section">
            <div class="section-header"><i class="material-icons">search</i>Student Search</div>
            <div class="input-field" style="margin-top:0;">
              <input id="search-term" type="text" placeholder="Enter name or ID" onchange="handleSearch()">
            </div>
          </div>
          <div class="section">
            <div class="section-header"><i class="material-icons">photo_camera</i>Class Photo Viewer</div>
            <div class="input-field"><select id="year-group-selector" onchange="handleYearGroupChange(this.value)">${createOptions(data.yearGroups, 'Year Group')}</select></div>
            <div class="input-field"><select id="class-selector" disabled><option value="" disabled selected>Class</option></select></div>
            ${peSection}
            <div class="btn-group">
              <button id="btn-year" class="btn-small" onclick="handleView('year')">Year</button>
              <button id="btn-class" class="btn-small" onclick="handleView('class')">Class</button>
              <button id="btn-pe" class="btn-small" onclick="handleView('pe')">PE</button>
            </div>
          </div>
        </div>`;
      app.innerHTML = html;
      M.FormSelect.init(document.querySelectorAll('select'));
    }

    function renderSearchResults(results) {
      window.appState.currentList = results.map(s => s.row);
      const html = `
        <div class="card-panel">
          ${createNavBar()}
          <div class="section">
            <div class="section-header">Results (${results.length})</div>
            ${createStudentList(results, 'No results found.')}
          </div>
        </div>`;
      app.innerHTML = html;
    }

    function renderStudentDetails(s) {
      window.appState.currentIndex = window.appState.currentList.indexOf(parseInt(s.row));
      
      const html = `
        <div class="card-panel">
          ${createNavBar(true)}
          <h5 class="center-align" style="padding:16px 0;">${s.name}</h5>
          <img src="${s.photoUrl}" class="student-photo">
          <div class="section">
            <div class="section-header">Details</div>
            ${item('Admission', s.admissionNumber)}
            ${item('DOB', s.dob)}
            ${item('Form', `${s.yearGroup} / ${s.form}`)}
          </div>
          <div class="section">
            <div class="section-header">Contact</div>
            ${emailItem('Student', s.email)}
            ${item("Father's Mobile", s.fatherMobile)}
            ${emailItem("Father's Email", s.fatherEmail)}
            ${item("Mother's Mobile", s.motherMobile)}
            ${emailItem("Mother's Email", s.motherEmail)}
            ${item('Parents Greeting', 'Coming soon')}
          </div>
          <div class="section">
            <div class="section-header">Medical</div>
            ${item('Medical Info', s.medicalComments)}
            ${item('Ailment', s.ailment)}
            ${item('Allergy', s.allergy)}
          </div>
        </div>`;
      app.innerHTML = html;
    }

    function renderPhotoViewer(data) {
      window.appState.currentList = data.students.map(s => s.row);
      let grid = '';
      data.students.forEach(s => {
        grid += `<div class="photo-grid-item" onclick="handleSelectStudent('${s.row}')"><img src="${s.photoUrl}"><div class="name">${s.name}</div></div>`;
      });
      
      const html = `
        <div class="card-panel">
          ${createNavBar()}
          <div class="section">
            <h6>${data.title} (${data.students.length})</h6>
            <div class="photo-grid">${grid}</div>
          </div>
        </div>`;
      app.innerHTML = html;
    }

    // --- UTILS ---
    function createNavBar(details=false) {
      return `<div class="nav-bar section">
        <a onclick="handleHome()"><i class="material-icons">home</i></a>
        ${details ? `<a onclick="handleNav(-1)"><i class="material-icons">arrow_back</i></a><a onclick="handleNav(1)"><i class="material-icons">arrow_forward</i></a>` : ''}
      </div>`;
    }
    
    function createStudentList(list, msg) {
      if(!list.length) return `<p>${msg}</p>`;
      return list.map(s => `<div class="student-list-item" onclick="handleSelectStudent('${s.row}')"><img src="${s.photoUrl}"><div class="info"><span class="name">${s.name}</span><span class="email">${s.email||''}</span></div></div>`).join('');
    }

    function createOptions(list, ph) {
      let opts = `<option value="" disabled selected>${ph}</option>`;
      list.forEach(i => opts += `<option value="${i.name}">${i.name} ${i.count?'('+i.count+')':''}</option>`);
      return opts;
    }

    function item(lbl, val) { 
        if(!val || val === 'N/A') return '';
        return `<div class="detail-item"><span class="label">${lbl}</span><span class="value">${val}</span></div>`; 
    }
    
    function emailItem(lbl, email) {
        if(!email || email === 'N/A') return '';
        return `<div class="detail-item"><span class="label">${lbl}</span><a href="mailto:${email}" class="email-link">${email} <i class="material-icons tiny">email</i></a></div>`;
    }

    function showLoader() { app.innerHTML = '<div style="display:flex;justify-content:center;padding:50px;"><div class="preloader-wrapper active"><div class="spinner-layer spinner-blue-only"><div class="circle-clipper left"><div class="circle"></div></div></div></div></div>'; }
    function showError(e) { app.innerHTML = `<div class="card-panel red white-text">${e.message}</div>`; }

    // --- ACTIONS ---
    function handleHome() { showLoader(); google.script.run.withSuccessHandler(initApp).getHomepageData(); }
    
    function handleSearch() {
      const t = document.getElementById('search-term').value;
      if(t) { showLoader(); google.script.run.withSuccessHandler(renderSearchResults).searchSheetLive(t); }
    }

    function handleSelectStudent(row) {
      showLoader(); google.script.run.withSuccessHandler(renderStudentDetails).getStudentDetailsForWebApp(row);
    }

    function handleNav(dir) {
      const idx = window.appState.currentIndex + dir;
      if(idx >= 0 && idx < window.appState.currentList.length) handleSelectStudent(window.appState.currentList[idx]);
    }

    function handleYearGroupChange(yg) {
      const data = window.appState.classHierarchy[yg];
      const sel = document.getElementById('class-selector');
      if(data) {
        sel.innerHTML = createOptions(data.classes.map(c=>({name:c})), 'Class');
        sel.disabled = false;
      }
      M.FormSelect.init(sel);
    }

    function handleView(type) {
      const yg = document.getElementById('year-group-selector').value;
      const fm = document.getElementById('class-selector').value;
      // Fixed the ternary operator syntax here
      const pe = document.getElementById('pe-selector') ? document.getElementById('pe-selector').value : null;
      
      const params = { yearGroup: yg, form: fm, peClass: pe };
      if(type === 'year' && !yg) return;
      if(type === 'class' && (!yg || !fm)) return;
      if(type === 'pe' && !pe) return;

      showLoader();
      google.script.run.withSuccessHandler(renderPhotoViewer).getStudentsForView(type, params);
    }

    // PWA Install Logic
    if('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>
