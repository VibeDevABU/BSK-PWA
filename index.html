<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BISC Side-Kick</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="icon.png">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

  <style>
    body { background-color: #f5f5f5; color: #3c4043; font-family: 'Roboto', sans-serif; padding-bottom: 20px; }
    .container { max-width: 450px; margin-top: 10px; }
    .card-panel { padding: 0; border: 1px solid #dadce0; border-radius: 8px; background-color: #fff; }
    .section { border-bottom: 1px solid #e0e0e0; padding: 16px; }
    .section-header { font-size: 1rem; font-weight: 500; color: #3c4043; display: flex; align-items: center; margin-bottom: 16px; }
    .section-header i { margin-right: 16px; color: #5f6368; }
    .nav-bar { display: flex; justify-content: space-around; padding: 8px 0; background-color: #fff; }
    .nav-bar a { color: #5f6368; cursor: pointer; }
    .student-list-item { display: flex; align-items: center; padding: 12px 0; cursor: pointer; border-top: 1px solid #e8eaed; }
    .student-list-item img { width: 40px; height: 40px; border-radius: 4px; margin-right: 16px; object-fit: cover; }
    .student-list-item .info { display: flex; flex-direction: column; }
    .student-list-item .info .name { font-weight: 500; color: #202124; }
    .student-list-item .info .email { font-size: 0.875rem; color: #5f6368; }
    .student-photo { max-width: 280px; border-radius: 8px; margin: 16px auto; display: block; }
    .detail-item { margin-bottom: 16px; }
    .detail-item .label { font-size: 0.75rem; color: #5f6368; display: block; margin-bottom: 2px; }
    .detail-item .value { font-size: 1rem; color: #202124; }
    .btn-group { display: flex; justify-content: space-between; margin-top: 16px; }
    .btn-group .btn-small { width: 32%; background-color: #fff; color: #3c4043; border: 1px solid #dadce0; box-shadow: none; }
    .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 16px; }
    .photo-grid-item { text-align: center; cursor: pointer; }
    .photo-grid-item img { width: 100%; border-radius: 4px; object-fit: cover; aspect-ratio: 3/4; }
    .photo-grid-item .name { font-size: 0.8rem; margin-top: 4px; line-height: 1.2; }
    .email-link { color: #1a73e8; text-decoration: none; display: flex; align-items: center; }
    .email-link i { font-size: 16px; margin-left: 4px; color: #5f6368; }
  </style>
</head>

<body>
  <div id="app-container" class="container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script>
    // --- PASTE URL HERE ---
    const API_URL = "PASTE_YOUR_PERSONAL_WEB_APP_URL_HERE";

    const google = {
      script: {
        run: {
          success:null, failure:null,
          withSuccessHandler(cb) { this.success=cb; return this; },
          withFailureHandler(cb) { this.failure=cb; return this; },
          
          getHomepageData() { this._call('getHomepageData'); },
          searchSheetLive(t) { this._call('search', {term:t}); },
          getStudentDetailsForWebApp(r) { this._call('getStudentDetails', {row:r}); },
          getStudentsForView(t, p) { this._call('getView', {viewType:t, yearGroup:p.yearGroup, form:p.form, peClass:p.peClass}); },
          webGenerateExport(t, p, f) { this._call('export', {type:t, format:f, yearGroup:p.yearGroup, form:p.form, peClass:p.peClass}); },
          webSendFeedback(t) { this._call('feedback', {text:t}); },

          _call(a, p={}) {
            const self=this;
            const url = new URL(API_URL);
            url.searchParams.append('action', a);
            for(let k in p) if(p[k]) url.searchParams.append(k, p[k]);
            
            fetch(url).then(r=>r.json()).then(d=>{
              if(d.error) self.failure && self.failure(new Error(d.error));
              else self.success && self.success(d);
            }).catch(e=>self.failure && self.failure(e));
          }
        }
      }
    };

    // --- CLIENT STATE ---
    const app = document.getElementById('app-container');
    const STORAGE_KEY = 'BISC_DATA_V1';
    
    // Load from LocalStorage
    const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{"starred":[], "recents":[]}');
    window.appState = { 
      hierarchy: {}, 
      peClasses: [],
      currentList: [], 
      currentIndex: -1, 
      starred: savedData.starred,
      recents: savedData.recents
    };

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        starred: window.appState.starred,
        recents: window.appState.recents
      }));
    }

    document.addEventListener('DOMContentLoaded', () => {
      showLoader();
      google.script.run.withSuccessHandler(initApp).withFailureHandler(showError).getHomepageData();
    });

    function initApp(data) {
      window.appState.hierarchy = data.classHierarchy;
      window.appState.peClasses = data.peClasses;
      renderHomepage();
    }

    // --- RENDERERS ---

    function renderHomepage() {
      const peOpts = createOptions(window.appState.peClasses, 'PE Class');
      const yearOpts = createOptions(window.appState.yearGroups || Object.keys(window.appState.hierarchy).map(k=>({name:k})), 'Year Group');
      
      const html = `
        <div class="card-panel">
          ${createNavBar()}
          <div class="section">
            <div class="section-header"><i class="material-icons">search</i>Student Search</div>
            <div class="input-field" style="margin-top:0;">
              <input id="search-term" type="text" placeholder="Name, ID, Email, Parent..." onchange="handleSearch()">
            </div>
          </div>
          <div class="section">
            <div class="section-header"><i class="material-icons">photo_camera</i>Class Photo Viewer</div>
            <div class="input-field"><select id="year-group-selector" onchange="handleYearGroupChange(this.value)">${yearOpts}</select></div>
            <div class="input-field"><select id="class-selector" disabled><option value="" disabled selected>Class</option></select></div>
            <div class="input-field"><select id="pe-selector">${peOpts}</select></div>
            <div class="btn-group">
              <button id="btn-year" class="btn-small" onclick="handleView('year')">Year</button>
              <button id="btn-class" class="btn-small" onclick="handleView('class')">Class</button>
              <button id="btn-pe" class="btn-small" onclick="handleView('pe')">PE</button>
            </div>
          </div>
          <ul class="collapsible">
            <li>
              <div class="collapsible-header"><i class="material-icons">history</i>Recent (${window.appState.recents.length})</div>
              <div class="collapsible-body" style="padding:16px;">${createStudentList(window.appState.recents, 'No recents.')}</div>
            </li>
            <li>
              <div class="collapsible-header"><i class="material-icons">star</i>Starred (${window.appState.starred.length})</div>
              <div class="collapsible-body" style="padding:16px;">${createStudentList(window.appState.starred, 'No starred students.')}</div>
            </li>
          </ul>
          <div class="section footer-buttons">
             <button class="btn-flat" onclick="renderHelp()">Help</button>
             <button class="btn-flat" onclick="renderFeedback()">Feedback</button>
          </div>
        </div>`;
      app.innerHTML = html;
      M.FormSelect.init(document.querySelectorAll('select'));
      M.Collapsible.init(document.querySelectorAll('.collapsible'));
    }

    function renderSearchResults(results) {
      window.appState.currentList = results.map(s => s.row);
      app.innerHTML = `
        <div class="card-panel">
          ${createNavBar()}
          <div class="section">
            <div class="section-header">Results (${results.length})</div>
            ${createStudentList(results, 'No results found.')}
          </div>
        </div>`;
    }

    function renderStudentDetails(s) {
      // Add to Recents
      addToRecents(s);
      
      window.appState.currentStudent = s;
      window.appState.currentIndex = window.appState.currentList.indexOf(parseInt(s.row));
      
      const isStarred = window.appState.starred.some(st => st.row == s.row);
      const starIcon = isStarred ? 'star' : 'star_border'; 
      const classLink = `<span style="color:#1a73e8;text-decoration:underline" onclick="handleView('class', '${s.yearGroup}', '${s.form}')">${s.yearGroup} / ${s.form}</span>`;

      app.innerHTML = `
        <div class="card-panel">
          ${createNavBar(true)}
          <h5 class="center-align" style="padding:16px 0;">
            ${s.name}
            <i class="material-icons right" style="cursor:pointer; color:#f9ab00;" onclick="toggleStar()">${starIcon}</i>
          </h5>
          <img src="${s.photoUrl}" class="student-photo">
          <div class="section">
            <div class="section-header">Details</div>
            ${item('Admission', s.admissionNumber)}
            ${item('DOB', s.dob)}
            ${item('Form', classLink)}
          </div>
          <div class="section">
            <div class="section-header">Contact</div>
            ${emailItem('Student', s.email)}
            ${item("Father's Mobile", s.fatherMobile)}
            ${emailItem("Father's Email", s.fatherEmail)}
            ${item("Mother's Mobile", s.motherMobile)}
            ${emailItem("Mother's Email", s.motherEmail)}
            ${item('Parents Greeting', 'Coming soon')}
          </div>
          <div class="section">
            <div class="section-header">Medical</div>
            ${item('Medical Info', s.medicalComments)}
            ${item('Ailment', s.ailment)}
            ${item('Allergy', s.allergy)}
          </div>
        </div>`;
    }

    function renderPhotoViewer(data, type) {
      window.appState.currentList = data.students.map(s => s.row);
      let grid = '';
      data.students.forEach(s => {
        grid += `<div class="photo-grid-item" onclick="handleSelectStudent('${s.row}')"><img src="${s.photoUrl}"><div class="name">${s.name}</div></div>`;
      });
      
      const p1 = type==='pe' ? 'pe' : 'class';
      const p2 = type==='pe' ? data.title.replace('PE Class: ','') : data.yearGroup;
      const p3 = type==='pe' ? '' : data.form;

      app.innerHTML = `
        <div class="card-panel">
          ${createNavBar()}
          <div class="section">
            <h6>${data.title} (${data.students.length})</h6>
            <div class="photo-grid">${grid}</div>
            <div class="center-align" style="margin-top:20px">
                <button class="btn-small white black-text" onclick="handleExport('pdf','${p1}','${p2}','${p3}')">PDF</button>
                <button class="btn-small white black-text" onclick="handleExport('doc','${p1}','${p2}','${p3}')">Doc</button>
            </div>
          </div>
        </div>`;
    }

    function renderExportSuccess(url, name) {
        app.innerHTML = `<div class="card-panel center-align" style="padding:40px">
            <i class="material-icons green-text" style="font-size:60px">check_circle</i>
            <h5>Export Ready!</h5>
            <p>${name}</p>
            <a href="${url}" target="_blank" class="btn blue">Open File</a>
            <br><br>
            <button class="btn-flat" onclick="renderHomepage()">Back Home</button>
        </div>`;
    }

    function renderFeedback() {
        app.innerHTML = `<div class="card-panel">
            ${createNavBar()}
            <h5>Feedback</h5>
            <textarea id="fb-text" class="materialize-textarea" placeholder="Message..."></textarea>
            <button class="btn blue" onclick="submitFeedback()">Send</button>
        </div>`;
    }
    
    function renderHelp() {
        app.innerHTML = `<div class="card-panel">
            ${createNavBar()}
            <h5>Help</h5>
            <p><b>Search:</b> Name, ID, Parent Email/Phone.</p>
            <p><b>Star:</b> Save students to favorites locally.</p>
            <p><b>Export:</b> Create PDF/Doc from Class View.</p>
        </div>`;
    }

    // --- ACTIONS ---
    
    function handleSearch() {
      const t = document.getElementById('search-term').value;
      if(t) { showLoader(); google.script.run.withSuccessHandler(renderSearchResults).searchSheetLive(t); }
    }

    function handleSelectStudent(row) {
      showLoader(); google.script.run.withSuccessHandler(renderStudentDetails).getStudentDetailsForWebApp(row);
    }

    function handleYearGroupChange(yg) {
      const data = window.appState.hierarchy[yg];
      const sel = document.getElementById('class-selector');
      if(data) {
        sel.innerHTML = createOptions(data.classes.map(c=>({name:c})), 'Class');
        sel.disabled = false;
      }
      M.FormSelect.init(sel);
    }

    function handleView(type, p2, p3) {
      let params = {};
      if(type==='class') { params.yearGroup = p2 || document.getElementById('year-group-selector').value; params.form = p3 || document.getElementById('class-selector').value; }
      else if(type==='year') { params.yearGroup = document.getElementById('year-group-selector').value; }
      else if(type==='pe') { params.peClass = document.getElementById('pe-selector').value; }
      
      if(type==='class' && (!params.yearGroup || !params.form)) return;
      
      showLoader();
      google.script.run.withSuccessHandler((d)=>renderPhotoViewer(d,type)).getStudentsForView(type, params);
    }

    function handleExport(fmt, type, p2, p3) {
        M.toast({html: 'Creating file (10s)...'});
        const params = { yearGroup: p2, form: p3, peClass: p2 }; // p2 is peClass for PE type
        google.script.run.withSuccessHandler((r) => {
            if(r.error) M.toast({html: 'Error: '+r.error});
            else renderExportSuccess(r.url, r.name);
        }).webGenerateExport(type, params, fmt);
    }

    function submitFeedback() {
        const t = document.getElementById('fb-text').value;
        if(t) google.script.run.withSuccessHandler(()=>M.toast({html:'Sent!'})).webSendFeedback(t);
    }

    // --- STATE LOGIC ---
    function toggleStar() {
        const s = window.appState.currentStudent;
        const idx = window.appState.starred.findIndex(st => st.row == s.row);
        if(idx > -1) window.appState.starred.splice(idx, 1);
        else window.appState.starred.push({ name:s.name, row:s.row, photoUrl:s.photoUrl, email:s.email });
        
        saveState();
        renderStudentDetails(s); // Re-render to toggle icon
        M.toast({html: idx > -1 ? 'Unstarred' : 'Starred'});
    }

    function addToRecents(s) {
        const recents = window.appState.recents;
        const exists = recents.findIndex(r => r.row == s.row);
        if(exists > -1) recents.splice(exists, 1);
        recents.unshift({ name:s.name, row:s.row, photoUrl:s.photoUrl, email:s.email });
        if(recents.length > 10) recents.pop();
        saveState();
    }

    // --- HELPER UTILS ---
    function showLoader() { app.innerHTML = '<div style="display:flex;justify-content:center;padding:50px;"><div class="preloader-wrapper active"><div class="spinner-layer spinner-blue-only"><div class="circle-clipper left"><div class="circle"></div></div></div></div></div>'; }
    function showError(e) { app.innerHTML = `<div class="card-panel red white-text"><b>Error:</b> ${e.message}</div>`; }
    function createNavBar(det) { return `<div class="nav-bar section"><a onclick="renderHomepage()"><i class="material-icons">home</i></a>${det ? `<a onclick="handleNav(-1)"><i class="material-icons">arrow_back</i></a><a onclick="handleNav(1)"><i class="material-icons">arrow_forward</i></a>`:''}</div>`; }
    function createStudentList(l,m) { return l.length ? l.map(s=>`<div class="student-list-item" onclick="handleSelectStudent('${s.row}')"><img src="${s.photoUrl}"><div class="info"><span class="name">${s.name}</span><span class="email">${s.email}</span></div></div>`).join('') : `<p>${m}</p>`; }
    function createOptions(l,p) { return `<option value="" disabled selected>${p}</option>` + l.map(i=>`<option value="${i.name}">${i.name} ${i.count?'('+i.count+')':''}</option>`).join(''); }
    function item(l,v) { return v && v!=='N/A' ? `<div class="detail-item"><span class="label">${l}</span><span class="value">${v}</span></div>` : ''; }
    function emailItem(l,e) { return e && e!=='N/A' ? `<div class="detail-item"><span class="label">${l}</span><a href="https://mail.google.com/mail/?view=cm&fs=1&to=${e}" target="_blank" class="email-link">${e} <i class="material-icons tiny">email</i></a></div>` : ''; }
    function handleNav(d) {
        const i = window.appState.currentIndex + d;
        if(i>=0 && i<window.appState.currentList.length) handleSelectStudent(window.appState.currentList[i]);
    }

    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
  </script>
</body>
</html>
