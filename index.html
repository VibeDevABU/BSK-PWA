<!DOCTYPE html>
<html>
<head>
  <!-- STEALTH MODE: Fixes "Failed to Fetch" -->
  <meta name="referrer" content="no-referrer">
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BISC Side-Kick</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="theme-color" content="#ffffff">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    /* STYLING - Identical to Sidebar */
    body { background-color: #f5f5f5; color: #3c4043; font-family: 'Roboto', sans-serif; margin:0; display:flex; justify-content:center; }
    #app-container { width:100%; max-width:450px; background:white; min-height:100vh; display:flex; flex-direction:column; box-shadow:0 0 15px rgba(0,0,0,0.1); }
    
    /* NAV BAR */
    .nav-bar { display:flex; justify-content:space-around; align-items:center; height:56px; background:#fff; border-bottom:1px solid #eee; position:sticky; top:0; z-index:99; }
    .nav-btn { padding:10px; cursor:pointer; color:#5f6368; }
    .nav-btn i { font-size:24px; }
    .nav-btn.active { color:#1a73e8; }
    .nav-btn.disabled { color:#e0e0e0; pointer-events:none; }

    /* CARDS */
    .card-panel { padding:16px; border-bottom:1px solid #e0e0e0; background:#fff; }
    .section-header { font-size:14px; font-weight:500; color:#3c4043; display:flex; align-items:center; margin-bottom:15px; text-transform:uppercase; }
    .section-header i { margin-right:12px; font-size:20px; color:#5f6368; }

    /* INPUTS */
    input, select { width:100%; padding:10px 0; border:none; border-bottom:1px solid #dadce0; font-size:16px; outline:none; background:transparent; margin-bottom:10px; border-radius:0; }
    input:focus, select:focus { border-bottom:2px solid #1a73e8; }
    
    /* BUTTONS */
    .btn-row { display:flex; gap:10px; margin-top:10px; }
    .btn { flex:1; padding:10px; text-align:center; border:1px solid #dadce0; border-radius:4px; cursor:pointer; font-weight:500; color:#3c4043; background:#fff; }
    .btn:active { background:#f1f3f4; }
    .btn.primary { background:#1a73e8; color:white; border:none; }

    /* LIST ITEMS */
    .list-item { display:flex; align-items:center; padding:12px 0; border-top:1px solid #f1f3f4; cursor:pointer; }
    .list-item img { width:40px; height:40px; border-radius:4px; margin-right:15px; object-fit:cover; background:#eee; }
    .list-item .text { display:flex; flex-direction:column; }
    .list-item .title { font-weight:500; font-size:14px; color:#202124; }
    .list-item .sub { font-size:12px; color:#5f6368; }

    /* STUDENT DETAILS */
    .student-photo { width:100%; max-width:240px; aspect-ratio:3/4; border-radius:8px; margin:10px auto; display:block; object-fit:cover; background:#eee; }
    .detail-row { margin-bottom:14px; }
    .label { font-size:11px; color:#5f6368; display:block; margin-bottom:4px; text-transform:uppercase; font-weight:500; }
    .val { font-size:15px; color:#202124; }
    .link { color:#1a73e8; text-decoration:none; cursor:pointer; }

    /* GRID */
    .grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; }
    .grid-item { text-align:center; cursor:pointer; }
    .grid-item img { width:100%; aspect-ratio:3/4; object-fit:cover; border-radius:4px; background:#eee; }
    .grid-item div { font-size:11px; margin-top:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .loader { padding:50px; text-align:center; color:#1a73e8; }
    .hidden { display:none; }
    .collapsible { border-top:1px solid #e0e0e0; }
    .coll-head { padding:15px; font-weight:500; cursor:pointer; display:flex; align-items:center; }
    .coll-head i { margin-right:15px; color:#5f6368; }
    .coll-body { display:none; }
    .coll-body.open { display:block; }
  </style>
</head>
<body>

<div id="app-container"></div>

<script>
// ======================================================
// === YOUR API URL (Must be correct) ===
// ======================================================
const API_URL = "https://script.google.com/macros/s/AKfycbydEfDnhHA8n-IMcdpiU4vYqwPxDwU_8Nq3Fqbw3N7jVsgztGykYkJb7fxW2PL3J-hPHw/exec";

// --- CLIENT STATE ---
window.appState = { 
    hierarchy: {}, peClasses: [], 
    currentList: [], currentIndex: -1, currentStudent: null,
    recents: JSON.parse(localStorage.getItem('recents')||'[]'),
    starred: JSON.parse(localStorage.getItem('starred')||'[]')
};

// --- THE API BRIDGE (This includes the missing 'call' function) ---
const google = { script: { run: {
    withSuccessHandler(s) { this.s=s; return this; }, withFailureHandler(f) { this.f=f; return this; },
    getHomepageData() { call('getHomepageData'); },
    searchSheetLive(t) { call('search', {term:t}); },
    getStudentDetailsForWebApp(r) { call('getStudentDetails', {row:r}); },
    getStudentsForView(t,p) { call('getView', {viewType:t, ...p}); },
    webSendFeedback(t) { call('feedback', {text:t}); }
}}};

// THIS IS THE FUNCTION YOU THOUGHT WAS MISSING
function call(a, p={}) {
    const u = new URL(API_URL); 
    u.searchParams.append('action', a);
    
    // Add timestamp to prevent cache issues
    u.searchParams.append('_t', new Date().getTime()); 

    for(let k in p) if(p[k]) u.searchParams.append(k, p[k]);
    
    fetch(u)
    .then(r => r.json())
    .then(d => {
        if(d.error) alert("API Error: "+d.error); 
        else window.google.script.run.s(d);
    })
    .catch(e => {
        // Retry once on failure
        console.log("Retrying...");
        setTimeout(() => {
             fetch(u).then(r=>r.json()).then(d=>window.google.script.run.s(d)).catch(err=>alert("Connection Failed: " + err));
        }, 1000);
    });
}

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    showLoader();
    google.script.run.withSuccessHandler(init).getHomepageData();
});

function init(data) {
    window.appState.hierarchy = data.classHierarchy;
    window.appState.peClasses = data.peClasses;
    renderHome();
}

// --- RENDERERS ---

function renderHome() {
    const s = window.appState;
    const yOpts = `<option value="" disabled selected>Year Group</option>` + Object.keys(s.hierarchy).map(k=>`<option value="${k}">${k}</option>`).join('');
    const pOpts = `<option value="" disabled selected>PE Class</option>` + s.peClasses.map(p=>`<option value="${p.name}">${p.name}</option>`).join('');

    document.getElementById('app-container').innerHTML = `
        <div class="card-panel" style="margin:10px; border-radius:8px; border:1px solid #dadce0;">
            ${createNavBar('home')}
            
            <div class="section">
                <div class="section-header"><i class="material-icons">search</i>Student Search</div>
                <input id="search" type="text" placeholder="Name, ID, Email..." onchange="handleSearch()">
            </div>

            <div class="section">
                <div class="section-header"><i class="material-icons">photo_camera</i>Class Viewer</div>
                <select id="year" class="browser-default" onchange="loadClasses()">${yOpts}</select>
                <select id="class" class="browser-default" disabled><option>Class</option></select>
                <select id="pe" class="browser-default">${pOpts}</select>
                <div class="btn-row">
                    <div class="btn" onclick="handleView('year')">Year</div>
                    <div class="btn" onclick="handleView('class')">Class</div>
                    <div class="btn" onclick="handleView('pe')">PE</div>
                </div>
            </div>

            <div class="collapsible">
                <div class="coll-head" onclick="toggleColl(this)"><i class="material-icons">history</i>Recent (${s.recents.length})</div>
                <div class="coll-body" style="padding:0 16px">${createList(s.recents,'No recents.')}</div>
            </div>
            <div class="collapsible">
                <div class="coll-head" onclick="toggleColl(this)"><i class="material-icons">star</i>Starred (${s.starred.length})</div>
                <div class="coll-body" style="padding:0 16px">${createList(s.starred,'No starred.')}</div>
            </div>
            <div style="text-align:center; padding:20px;">
                <span class="link" style="margin:0 10px" onclick="renderHelp()">Help</span>
                <span class="link" style="margin:0 10px" onclick="renderFeedback()">Feedback</span>
            </div>
        </div>`;
}

function renderDetails(s) {
    window.appState.currentStudent = s;
    window.appState.currentIndex = window.appState.currentList.indexOf(parseInt(s.row));
    addToRecents(s);
    const starIcon = window.appState.starred.some(x=>x.row==s.row) ? 'star' : 'star_border';

    document.getElementById('app-container').innerHTML = `
        <div class="card-panel" style="margin:10px; border-radius:8px; border:1px solid #dadce0;">
            ${createNavBar('details')}
            <h5 style="text-align:center; margin:16px 0; font-weight:400;">
                ${s.name} <i class="material-icons" style="float:right; color:#f9ab00; cursor:pointer;" onclick="toggleStar()">${starIcon}</i>
            </h5>
            <img src="${s.photoUrl}" class="student-photo">
            
            <div class="section-header">üë§ Student Details</div>
            ${item('Admission', s.admissionNumber)}
            ${item('DOB', s.dob)}
            ${item('Form', `<span class="link" onclick="handleView('class','${s.yearGroup}','${s.form}')">${s.yearGroup} / ${s.form}</span>`)}
            
            <div style="height:20px"></div>
            <div class="section-header">üìû Contact Info</div>
            ${emailItem('Student', s.email)}
            ${item("Father's Mobile", s.fatherMobile)}
            ${emailItem("Father's Email", s.fatherEmail)}
            ${item("Mother's Mobile", s.motherMobile)}
            ${emailItem("Mother's Email", s.motherEmail)}
            ${item("Parents Greeting", "Coming soon")}

            <div style="height:20px"></div>
            <div class="section-header">‚öïÔ∏è Medical</div>
            ${item('Medical Info', s.medicalComments)}
            ${item('Allergy', s.allergy)}
        </div>`;
}

function renderViewer(data) {
    window.appState.currentList = data.students.map(s => s.row);
    const grid = data.students.map(s => `<div class="grid-item" onclick="fetchStudent('${s.row}')"><img src="${s.photoUrl}" loading="lazy"><div>${s.name}</div></div>`).join('');
    document.getElementById('app-container').innerHTML = `
        <div class="card-panel" style="margin:10px; border-radius:8px; border:1px solid #dadce0;">
            ${createNavBar()}
            <div class="section">
                <div class="section-header">${data.title} (${data.students.length})</div>
                <div class="grid">${grid}</div>
            </div>
        </div>`;
}

// --- UTILS ---
function createNavBar(ctx) {
    const d = ctx === 'details';
    return `<div class="nav-bar">
        <i class="material-icons nav-btn" onclick="renderHome()">home</i>
        <i class="material-icons nav-btn" onclick="focusSearch()">search</i>
        <i class="material-icons nav-btn ${!d?'disabled':''}" onclick="nav(-1)">arrow_back</i>
        <i class="material-icons nav-btn ${!d?'disabled':''}" onclick="nav(1)">arrow_forward</i>
        <i class="material-icons nav-btn" onclick="viewStarred()">star</i>
    </div>`;
}

function createList(l,m) {
    if(!l.length) return `<div style="padding:10px; color:#999;">${m}</div>`;
    return l.map(s => `<div class="list-item" onclick="fetchStudent('${s.row}')"><img src="${s.photoUrl}"><div class="text"><span class="title">${s.name}</span><span class="sub">${s.email||''}</span></div></div>`).join('');
}

function item(l, v) { return (!v||v=='N/A') ? '' : `<div class="detail-row"><span class="label">${l}</span><span class="val">${v}</span></div>`; }
function emailItem(l, v) { return (!v||v=='N/A') ? '' : `<div class="detail-row"><span class="label">${l}</span><a href="https://mail.google.com/mail/?view=cm&fs=1&to=${v}" target="_blank" class="link">${v} <i class="material-icons tiny">email</i></a></div>`; }
function showLoader() { document.getElementById('app-container').innerHTML = '<div class="loader"><i class="material-icons" style="font-size:40px; animation:spin 1s infinite linear">autorenew</i></div>'; }
function renderHelp() { document.getElementById('app-container').innerHTML = `<div class="card-panel" style="margin:10px">${createNavBar()}<h5>Help</h5><p>Use search, filters, or starred.</p><div class="btn" onclick="renderHome()">Back</div></div>`; }
function renderFeedback() { document.getElementById('app-container').innerHTML = `<div class="card-panel" style="margin:10px">${createNavBar()}<h5>Feedback</h5><input id="fb" placeholder="Message"><div class="btn primary" onclick="subFB()">Send</div></div>`; }

function handleSearch() { const t=document.getElementById('search').value; if(t) { showLoader(); google.script.run.withSuccessHandler(renderSearchResults).searchSheetLive(t); }}
function fetchStudent(r) { showLoader(); google.script.run.withSuccessHandler(renderDetails).getStudentDetailsForWebApp(r); }
function handleView(t,y,f) {
    const p = {yearGroup: y||document.getElementById('year').value, form: f||document.getElementById('class').value, peClass: document.getElementById('pe').value};
    if((t=='class'&&(!p.yearGroup||!p.form)) || (t=='year'&&!p.yearGroup) || (t=='pe'&&!p.peClass)) return;
    showLoader(); google.script.run.withSuccessHandler(d=>renderViewer(d)).getStudentsForView(t,p);
}
function loadClasses() {
    const y = document.getElementById('year').value;
    const s = document.getElementById('class');
    s.innerHTML = `<option disabled selected>Class</option>` + window.appState.hierarchy[y].classes.map(c=>`<option value="${c}">${c}</option>`).join('');
    s.disabled = false;
}
function nav(d) { const i=window.appState.currentIndex+d; if(i>=0 && i<window.appState.currentList.length) fetchStudent(window.appState.currentList[i]); }
function toggleStar() {
    const s=window.appState.currentStudent; const i=window.appState.starred.findIndex(x=>x.row==s.row);
    if(i>-1) window.appState.starred.splice(i,1); else window.appState.starred.push({name:s.name,row:s.row,photoUrl:s.photoUrl,email:s.email});
    localStorage.setItem('starred', JSON.stringify(window.appState.starred)); renderDetails(s);
}
function addToRecents(s) {
    const r=window.appState.recents; const i=r.findIndex(x=>x.row==s.row);
    if(i>-1) r.splice(i,1); r.unshift({name:s.name,row:s.row,photoUrl:s.photoUrl,email:s.email});
    if(r.length>5) r.pop(); localStorage.setItem('recents', JSON.stringify(r));
}
function viewStarred() { document.getElementById('app-container').innerHTML=`<div class="card-panel" style="margin:10px">${createNavBar()}<div class="section-header">Starred</div>${createList(window.appState.starred,'No favorites.')}</div>`; }
function renderSearchResults(l) { window.appState.currentList=l.map(s=>s.row); document.getElementById('app-container').innerHTML=`<div class="card-panel" style="margin:10px">${createNavBar()}<div class="section-header">Results</div>${createList(l,'None')}</div>`; }
function subFB() { const t=document.getElementById('fb').value; if(t) google.script.run.withSuccessHandler(()=>alert('Sent!')).webSendFeedback(t); }
function toggleColl(el) { el.nextElementSibling.classList.toggle('open'); }
function focusSearch() { renderHome(); setTimeout(()=>document.getElementById('search').focus(),100); }

if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
<style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
</body>
</html>
